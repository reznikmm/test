on: [push, pull_request]

permissions: write-all

name: Build binaries
jobs:
  build:
    name: Build and deploy
    runs-on: macos-11
    steps:
      - name: Get sources
        uses: actions/checkout@v2
      - name: Find objcopy
        run: |
           brew install binutils
           export PATH="/usr/local/opt/binutils/bin:$PATH"
           objcopy --help
           type objcopy
           which objcopy
      - name: Get GNAT toolchain with alire
        uses: alire-project/setup-alire@v2
        with:
          toolchain: gnat_native gprbuild
      - name: Build sources
        run: |
          set -e -x
          alr build
          ulimit -c unlimited
          mkdir core-dump
          echo "$PWD/core-dump/corefile-%e-%p-%t" | sudo tee /proc/sys/kernel/core_pattern
          ./bin/test | true

      - uses: actions/upload-artifact@master
        with:
          name: crashes
          path: ./core-dump/*
